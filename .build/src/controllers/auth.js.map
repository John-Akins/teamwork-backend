{"version":3,"sources":["../../../src/controllers/auth.js"],"names":["authController","signin","req","res","errors","isEmpty","status","json","error","array","userEmail","body","email","userPassword","password","query","name","text","values","db","queryWhere","then","user","undefined","userId","isAdmin","bcrypt","compare","valid","token","jwt","sign","expiresIn","data","jobRole","emailExists","Promise","resolve","reject","createUser","firstName","lastName","address","gender","department","isDuplicate","Date","getTime","headers","authorization","split","hash","message"],"mappings":"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","sourcesContent":["import bcrypt from \"bcrypt\"\nimport jwt from \"jsonwebtoken\"\nimport { validationResult } from \"express-validator\"\n\nimport db from \"../db\"\n\nconst authController = {}\n\nauthController.signin = (req, res) => {\n\t// Get input validation status\n\tconst errors = validationResult(req)\n\tif (!errors.isEmpty()) \n\t{\n\t\treturn res.status(422).json({\n\t\t\tstatus: \"error\",\n\t\t\terror: errors.array()\n\t\t})\t\t\t\t\n\t}\n\n\tconst userEmail = req.body.email\n\tconst userPassword = req.body.password\t\n\n\tconst query = {\n\t\tname: \"fetch-user\",\n\t\ttext: \"SELECT * FROM users WHERE email = $1\",\n\t\tvalues: [userEmail]\n\t}\n\tdb.queryWhere(query)\n\t\t.then((user) => {\n\t\t\tif(user[0] === undefined)\n\t\t\t{\n\t\t\t\treturn res.status(401).json({\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"incorrect email or password\"\n\t\t\t\t})\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst userId = user[0].userId \n\t\t\t\tconst isAdmin = user[0].isAdmin\n\t\t\t\tbcrypt.compare(userPassword, user[0].password)\n\t\t\t\t\t.then((valid) => {\n\t\t\t\t\t\tif(!valid)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn res.status(401).json({\n\t\t\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\t\t\terror: \"incorrect email or password\"\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} \n\t\t\t\t\t\tconst token = jwt.sign({userId: userId, isAdmin: isAdmin},\"$hdsJmzjQ7,E.m2y$12$1iTvLIHS60iMROUjADnu8tdiUguselTrWjDo6SxVf\",\n\t\t\t\t\t\t\t{expiresIn: \"24h\"}\n\t\t\t\t\t\t)\n\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\tstatus : \"success\",\n\t\t\t\t\t\t\tdata : {\n\t\t\t\t\t\t\t\ttoken : token,\n\t\t\t\t\t\t\t\tuserId: user[0].userId,\n\t\t\t\t\t\t\t\tjobRole: user[0].jobRole\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})           \t\t\t\t\t\t\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error)  => {\n\t\t\t\t\t\tres.status(401).json({\n\t\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\t\terror: \"incorrect email or password\",\n\t\t\t\t\t\t})                    \n\t\t\t\t\t})\n\t\t\t}\n\t\t})\n\t\t.catch((error) => {\n\t\t\tres.status(403).json({\n\t\t\t\tstatus: \"error\",\n\t\t\t\terror: \"server error\"\n\t\t\t})\n\t\t})\n}\n\n\nconst emailExists = (email) => {\n\treturn new Promise((resolve, reject) => {\n\t\tconst query = {\n\t\t\t// give the query a unique name\n\t\t\tname: \"fetch-user\",\n\t\t\ttext: \"SELECT * FROM users WHERE email = $1\",\n\t\t\tvalues: [email],\n\t\t}\n\t\tdb.queryWhere(query)\n\t\t\t.then((user) => {\n\t\t\t\tif(user[0] !== undefined)\n\t\t\t\t{\n\t\t\t\t\tresolve(true)\n\t\t\t\t}\n\t\t\t\tresolve(false)\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\treject({\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"could not perform request\"\n\t\t\t\t})\n\t\t\t})\n\t})\n}\n\n\nauthController.createUser = (req, res) => {\n\tconst errors = validationResult(req)\n\tif (!errors.isEmpty())\n\t{\n\t\treturn res.status(422).json({\t\n\t\t\tstatus: \"error\",\n\t\t\terror: errors.array()\n\t\t})\n\t}\n\t\n\tconst { firstName, lastName, email, address, password, gender, jobRole, department, isAdmin } = req.body\n\n\temailExists(email)\n\t\t.then((isDuplicate) => {\n\t\t\tif(isDuplicate === true)\n\t\t\t{\n\t\t\t\treturn res.status(402).json({\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"this email already exists\"\n\t\t\t\t})\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst userId = new Date().getTime()\n\t\t\t\tconst token = (! req.headers.authorization) ? \"\" : req.headers.authorization.split()[1]\n\t\t\t\tbcrypt.hash(password, 10).then(\n\t\t\t\t\t(hash) => {\n\t\t\t\t\t\tconst query = {\n\t\t\t\t\t\t\tname: \"create-user\",\n\t\t\t\t\t\t\ttext: \"INSERT INTO users(\\\"userId\\\", \\\"firstName\\\", \\\"lastName\\\", \\\"email\\\", \\\"address\\\", \\\"password\\\", \\\"gender\\\", \\\"jobRole\\\", \\\"department\\\", \\\"isAdmin\\\", \\\"isNewAccount\\\") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\",\n\t\t\t\t\t\t\tvalues: [userId, firstName, lastName, email, address, hash, gender, jobRole, department, isAdmin, true]\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdb.queryWhere(query)\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\t\t\tstatus : \"success\",\n\t\t\t\t\t\t\t\t\tdata : {\n\t\t\t\t\t\t\t\t\t\tmessage: \"User account successfully created\",\n\t\t\t\t\t\t\t\t\t\ttoken : token,\n\t\t\t\t\t\t\t\t\t\tuserId: userId,\n\t\t\t\t\t\t\t\t\t\tjobRole: jobRole\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\t\t\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\t\t\tres.status(500).json({\n\t\t\t\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\t\t\t\terror: \"Internal server error \"  + error\n\t\t\t\t\t\t\t\t})\t\n\t\t\t\t\t\t\t})\t\t\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tres.status(500).json({\n\t\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\t\terror: error\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\t\t\t}\n\t\t})\n\t\t.catch((error) => {\n\t\t\tres.status(500).json({\n\t\t\t\tstatus: \"error\",\n\t\t\t\terror: error\n\t\t\t})\n\t\t})\n\n}\n\nexport default authController"],"file":"auth.js"}